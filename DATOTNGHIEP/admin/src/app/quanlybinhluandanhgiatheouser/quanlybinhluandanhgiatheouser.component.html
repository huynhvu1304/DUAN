<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Quản Lý Bình Luận & Đánh Giá Theo Người Dùng</h4>
        <h6>Xem và quản lý đánh giá theo người dùng</h6>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <!-- Search bar -->
        <mat-form-field appearance="outline" class="w-100 mb-3">
          <mat-label>Tìm kiếm người dùng</mat-label>
          <input matInput (keyup)="applyFilter($event)" placeholder="Nhập tên người dùng...">
        </mat-form-field>

        <!-- Table -->
        <div class="table-responsive">
          <table mat-table [dataSource]="dataSource" matSort class="w-100">
            
            <!-- STT Column -->
            <ng-container matColumnDef="stt">
              <th mat-header-cell *matHeaderCellDef> STT </th>
              <td mat-cell *matCellDef="let item; let i = index">
                {{i + 1 + (paginator.pageIndex * paginator.pageSize)}}
              </td>
            </ng-container>

            <!-- User ID Column -->
            <ng-container matColumnDef="user_id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ID Người Dùng </th>
              <td mat-cell *matCellDef="let item">{{item.user_id}}</td>
            </ng-container>

            <!-- User Name Column -->
            <ng-container matColumnDef="userName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Tên Người Dùng </th>
              <td mat-cell *matCellDef="let item">{{item.userName}}</td>
            </ng-container>

            <!-- Comment Count Column -->
            <ng-container matColumnDef="commentCount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Số Lượng Bình Luận </th>
              <td mat-cell *matCellDef="let item">{{item.commentCount}}</td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Thao tác </th>
              <td mat-cell *matCellDef="let item">
                <!-- Nút xem chi tiết -->
                <button mat-icon-button (click)="openUserDetails(item)" 
                        matTooltip="Xem chi tiết">
                  <i class="bi bi-eye"></i>
                </button>
                
                <!-- Nút toggle trạng thái bình luận -->
                <button mat-icon-button 
                        (click)="toggleCommentStatus(item.user_id)" 
                        [matTooltip]="item.statuscomment === 'Cấm bình luận' ? 'Cho phép bình luận' : 'Cấm bình luận'"
                        class="toggle-button">
                    <i class="bi" 
                       [ngClass]="{
                         'bi-slash-circle-fill text-danger': item.statuscomment === 'Cấm bình luận',
                         'bi-check-circle-fill text-success': item.statuscomment === 'Cho phép bình luận'
                       }"
                       [style.fontSize]="'20px'">
                    </i>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <div *ngIf="dataSource.data.length === 0" class="text-center p-3">
            <p>Không tìm thấy kết quả phù hợp</p>
          </div>
        </div>
        <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
      </div>
    </div>
  </div>
</div>

<!-- Modal User Details -->
<div class="modal" tabindex="-1" [ngClass]="{ 'show': isDetailsOpen }" 
     style="display: block;" *ngIf="isDetailsOpen && selectedUser">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          Chi tiết bình luận của người dùng: {{selectedUser.userName}}
        </h3>
        <button type="button" class="btn-close" (click)="closeDetails()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Bộ lọc trạng thái hiển thị và phản hồi admin -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Trạng thái hiển thị</label>
            <select class="form-select" [(ngModel)]="reviewVisibilityFilter"
              (change)="setReviewVisibilityFilter(reviewVisibilityFilter)">
              <option value="all">Tất cả</option>
              <option value="visible">Đang hiện</option>
              <option value="hidden">Đang ẩn</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Phản hồi admin</label>
            <select class="form-select" [(ngModel)]="adminReplyFilter" (change)="setAdminReplyFilter(adminReplyFilter)">
              <option value="all">Tất cả</option>
              <option value="replied">Đã phản hồi</option>
              <option value="unreplied">Chưa phản hồi</option>
            </select>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>STT</th>
                <th>Sản phẩm</th>
                <th>Nội dung</th>
                <th>Đánh giá</th>
                <th>Ngày tạo</th>
                <th>Thao tác</th>
                <th>Ẩn/Hiện</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let comment of selectedUser.comments; let i = index">
                <td>{{i + 1}}</td>
                <td>
                  <div class="product-info d-flex align-items-center">
                    <img [src]="imageBaseUrl + comment.product_id.images_main" 
                         [alt]="comment.product_id.name"
                         class="me-2"
                         style="width: 50px; height: 50px; object-fit: cover;">
                    <span>{{comment.product_id.name}}</span>
                  </div>
                </td>
                <td>
                  <div>{{comment.content}}</div>
                  <!-- Hiển thị phản hồi admin nếu có -->
                  <div *ngIf="comment.admin_reply" class="admin-reply mt-2">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <small class="text-muted">Phản hồi admin:</small>
                        <p class="mb-0" *ngIf="selectedReplyId !== comment._id">{{comment.admin_reply}}</p>
                        <!-- Form chỉnh sửa phản hồi -->
                        <div *ngIf="selectedReplyId === comment._id" class="mt-2">
                          <div class="input-group">
                            <input type="text" class="form-control" 
                                   [(ngModel)]="editReplyContent"
                                   placeholder="Chỉnh sửa phản hồi...">
                            <button class="btn btn-primary btn-sm" (click)="updateReply(comment._id)">
                              <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">
                              <i class="bi bi-x"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex">
                        <button class="btn btn-link btn-sm text-danger p-0 me-2" (click)="deleteAdminReply(comment._id)"
                          *ngIf="selectedReplyId !== comment._id">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-link btn-sm text-primary p-0 ms-2" 
                                (click)="openEditReplyForm(comment._id, comment.admin_reply)"
                                *ngIf="selectedReplyId !== comment._id">
                          <i class="bi bi-pencil-square"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- Form phản hồi -->
                  <div *ngIf="selectedCommentId === comment._id" class="mt-2">
                    <div class="input-group">
                      <input type="text" class="form-control" 
                             [(ngModel)]="replyContent"
                             placeholder="Nhập phản hồi...">
                      <button class="btn btn-primary" (click)="submitReply(comment._id)">
                        Gửi
                      </button>
                      <button class="btn btn-secondary" (click)="closeReplyForm()">
                        Hủy
                      </button>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="rating">
                    <div class="stars">
                      <i class="bi" 
                         *ngFor="let star of [1,2,3,4,5]"
                         [ngClass]="{
                           'bi-star-fill text-warning': star <= comment.rating,
                           'bi-star': star > comment.rating
                         }">
                      </i>
                    </div>
                    <small class="text-muted ms-2">({{comment.rating}}/5)</small>
                  </div>
                </td>
                <td>{{comment.created_at | date:'dd/MM/yyyy'}}</td>
                <td>
                  <button class="btn btn-sm btn-info me-1" 
                          (click)="openReplyForm(comment._id)"
                          *ngIf="!comment.admin_reply">
                    <i class="bi bi-chat-dots"></i>
                  </button>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <label class="switch">
                      <input type="checkbox" [checked]="!comment.isDeleted" (change)="toggleReviewDelete(comment)">
                      <span class="slider round"></span>
                    </label>
                  </div>
                  <span class="ms-1">
                    <span [ngClass]="!comment.isDeleted ? 'text-success fw-bold' : 'text-muted'">Hiện</span>
                    /
                    <span [ngClass]="comment.isDeleted ? 'text-danger fw-bold' : 'text-muted'">Ẩn</span>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div
  class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50"
  style="z-index: 1040;"
  *ngIf="isDetailsOpen"
></div>
